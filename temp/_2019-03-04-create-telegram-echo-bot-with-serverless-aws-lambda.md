---
title: "Создаем телеграм бота с помощью serverless технологий на nodejs"
description:
date: 2019-03-04
tags:
  - nodejs
  - lambda
  - aws
  - serverless
  - telegram
  - tutorial
layout: layouts/post.njk
---
Всем привет!

Надеюсь вы готовы сделать сделать шаг в будущее? Будущее DevOps-а и, скорее всего, вашей будущей жизни в качестве фул-стек разработчика? Конечно, я немного преувеличиваю, но serverless (переводится как _«бессерверные»_) технологии заслуживают внимание.

**Наш план на сегодня:**

- Разберемся что это за зверь, **поговорим о том, как работают «бессерверные» приложения** и что с их помощью можно создавать.
- Узнаем плюсы и минусы облачных функций (в частности, AWS-лямбд)
- Рассмотрим одноименный с технологией фреймворк **serverless** и создадим нашу первую лямбда-функцию.
- Создадим бота в телеграме и напишем лямбду с помощью serverless-a для обработки сообщений.
- В заключении рассмотрим, для чего еще применимы лямбды.

Перед началом у вас должен быть аккаунт в AWS с админскими правами (нужен именно уровень доступа администратора, иначе все может работать не так, как нужно); бесплатно создать его можно [тут](https://portal.aws.amazon.com/billing/signup#/start). И установлена Nodejs v8 и выше.

## Что такое serverless? Что такое AWS Lambda?

*Есть много решений, как платных, так и опенсорсных, но мы будем рассматривать только AWS и serverless, как самые популярные решения в этой области.*

Начем с того, что можно понимать под "облаками" и облачными вычислениями? Это модель обеспечения удобного доступа к вычислительным ресурсам, которые поставляет поставщик (например, амазон) и отвечает за запуск вашего кода, распределение ресурсов (масштабирование), мониторинг и т.д. **Бессерверные вычисления** - это модель выполнения облачных вычислений, в которой нам, разработчикам, совсем не нужно думать о серверах - всю работу с ними берет на себя поставщик услуг.

Вы сейчас можете сказать: "wft, какие же это бессерверная технология, если все запускается на серверах?". Конечно же, она не такая уж и бессерверная, ваш код будет запускаться серверах, но как там все устроено?

Мы написали функцию, загрузили ее на сервер (об этом чуть ниже). При возникновении какого-нибудь события (event) она запускается на серверах в контейнере (например в докере). **Эта функция в контейнере и называется лямбдой-функцией или просто лямбдой**. Лямбды являются основной единицей данной архитектуры и выполняют определенную задачу в контейнерах, которые не доступны конечному пользователю. Пользователь можно только задеплоить функции и подключить к ней источники событий.

> Опять вопрос из зала: "В чем суть, зачем нам запускать какую-то функцию в контейнере?"

Сейчас разложим все по полочкам и расмотрим подробнее процесс работы лямбд. Схематично лямбду можно представить так:

<img src="/static/images/aws-lambda/2019-02-25_23-39-16.png" />

Как только вы загружаете код функции в AWS (ее можно загрузить разными способами, сразу написав ее в онлайн IDE, загрузить с помощью AWS CLI или использовать фреймворк, который поможет загрузить проект одной командой), он сохраняется в качестве пакета на внутренних серверах амазона. В момент получения события (например, http-запрос), автоматически запускается контейнер с определенным интерпретатором (или виртуальной машиной, в случае java; Да-да, лямбда это не только javascript, на ней можно запускать код на разных языках, таких как golang, .net, java, python и nodejs), который выполняет полученный код, подставляя тело события в качестве первого аргумента:

```js
/* Пример самой простой лямбды */
module.exports.handler = (event, context, callback) => {
    const response = {
        statusCode: 200,
        body: '<h1>Hello, Lambda</h1>'
    };
    
    callback(null, response);
};
```

Источником событий могут быть самые разные сервисы (в рамках амазона, это их же сервисы):

- Например при добавлении/удалении файла в S3 (файловое хранилище)
- При изменении данных в таблице DynamoDB (база данных от амазона)
- При использовании планировщика задач Cloudwatch
- И то, что нам будет интереснее всего - это **API Gateway, который позволяет обрабатывать http запросы и абстрагировать их до события для лямбды**.
 
В случае лямбды мы можем совсем не думать о серверах. Мы работаем с лямбдой не так, как мы работаем с обычными серверами. Как работает обычное приложение на Nodejs? Мы запускаем http-сервер, который слушает указанный порт. Как только прилетает запрос, мы начинаем его обработку. К вам скорее всего закрались сомнения, что на каждый запрос поднимать свой контейтер и запускать сервер заново плохая идея, и на это будет уходить довольно много времени. Это был мой первый вопрос, когда я познакомился с serverless: как же на нем запустить http-сервер?

Тут вступает такое понятие, как **время холодного старта**. Это время, которое необходимо для первого (или если лямбда долго не вызывалась) запуска контейнера и приложения. Для лямбд на Nodejs оно не так уж и велико, и составляет менее 200 мс (по сравнению например с Java или C#, которые требуют 5-6 секунд. Вы можете [почитать материал](https://read.acloud.guru/does-coding-language-memory-or-package-size-affect-cold-starts-of-aws-lambda-a15e26d12c76), где описано, как можно получить это значение). Самое интересное, что когда возникает второе событие, контейнер от первого может еще быть активным и переиспользовать загруженные в память модули или даже контейнеры (которые после выполнения функции еще живут какое-то время). 

Если это для вас проблема (200 мс), то функции можно разогревать, например каждые N секунд создавать событие для запуска функции.

Для каждого нового обработчика нужно создавать новую лямбду, что очень похоже на микросервисную архитектуру. Из этого принципа вытекает, что лямбда-функции не могу иметь состояния (они **stateless**). Благодоря этому при возникновении нагрузки и количества запросов без проблем происходит горизантальное масштабирование



Это говорит о том, что если использовать в лямбде какой-нибудь механизм кеширования, то он м


Как понятно из принципа микросервисов, каждая такая функция не может иметь состояния (stateless), так как доступа к контейнеру нет, и время его существования ничем не определено. Благодаря этому качеству микросервисы могут беспрепятственно горизонтально расти в зависимости от количества запросов и нагрузки. На самом деле, исходя из практики, балансирование ресурсов в Амазоне выполнено довольно-таки неплохо и функция достаточно быстро “плодится” даже при скачкообразных повышениях нагрузки.


С другой стороны, еще одно преимущество такого stateless запуска заключается в том, что оплату за использование сервиса, как правило, можно производить, основываясь на времени выполнения конкретной функции. Столь удобный способ оплаты – в англоязычной литературе Pay-as-you-go – даёт возможность запускать стартапы или иные проекты без начального капитала. Ведь необходимости выкупать хостинг для размещения кода – нет. Оплату можно производить пропорционально использованию сервиса (что так же гибко позволяет рассчитать необходимую монетизацию вашего сервиса).










Таким образом, плюсы подобной архитектуры – это:

Отсутствие аппаратной части – серверов;
Отсутствие прямого контактирования и администрирования серверной части;
Практически безграничный горизонтальный рост вашего проекта;
Оплата за использованное время ЦПУ.

К минусам же можно отнести:

Отсутствие чёткого контроля контейнера (вы никогда не знаете, где и как они запускаются, кто имеет доступ) – что нередко может вызывать паранойю.

Отсутствие “целостности” приложения: каждая функция – это независимый объект, что часто приводит к некой разбросанности приложения и затруднениям сложить все воедино.

Холодный старт контейнера оставляет желать лучшего (как минимум, в Амазоне). Первый запуск контейнера с лямбда функцией частенько может притормозить на 2-3 секунды, что не всегда хорошо воспринимается пользователями.

В общем и целом у технологии есть свой сегмент спроса и свой рынок потребителей. Я же нахожу технологию весьма подходящей для начального этапа стартапов, начиная от простейших блогов, заканчивая онлайн играми и не только. Особый упор в данном случае ставится на независимость от серверной инфраструктуры и безграничный прирост производительности в автоматическом режиме.





У вас 














https://docs.aws.amazon.com/en_us/lambda/latest/dg/welcome.html
https://egghead.io/lessons/aws-setup-the-serverless-framework








Сегодня хотелось бы рассказать о «безсерверной» архитектуре в рамках AWS (Amazon Web Services) и на примере разработать телеграм бота, который будет отвечать тем сообщением, которые получил. Вы удивитесь, насколько это просто и быстро.




Чем хороши безсерверные технологии? Тем, что нам не нужно беспокоится об обслуживании сервера. Достаточно написать свой код и загрузить его в облако (одной командой).

Вместо запущенного сервера 24/7, вы можете размещать функции-лямбды и сервер будет работать только в течении жизненного цикла запроса. Это отлично подходят для прототипирования, так как платите за количество конкретных запросов, а в случае, если используете AWS Lambda, то у вас в наличии 1 миллион бесплатных запросов в месяц.


На лямбдах можно запустить даже реакт приложение (рекомендую к просмотру доклад Марины Миронович, где она в качестве примера создает react приложение с серверным рендерингом: https://www.youtube.com/watch?v=wJcXVjemrEY)

ngrok
This makes any local servers reachable via the internet. It’s a great way to prototype web-hooks before actually deploying them to the cloud.

These tools helped me avoid a lot of the headache that goes into making a chatbot (e.g. renting a server, configuring it for HTTPS, figuring out how to make the server non-blocking since this is a chatbot).



http://aws.amazon.com/


### Создание телеграм бота

Если вы хотите посмотреть код, полученный в результате, можете сразу открывать github: [serverless-telegram-echo-bot](https://github.com/noveogroup-amorgunov/serverless-telegram-echo-bot).

<img src="/static/images/aws-lambda/preview.png" />

Я предполагаю, вы знакомы с Nodejs, но не разу не создавали ботов в телеграме. Если вам покажется какая-то часть сильно очевидной, то смело пропускайте ее.

Вообще, ребята из телеграм большие молодцы. Я создавал ботов для разных платформ, фейсбук, вконтакте, слака и самое приятое "[bot api](https://core.telegram.org/bots/api)" (в плане использования) оказалось у telegram. Для создания бота достаточно написать [@BotFather](https://t.me/botfather), в диалоге с которым вы можете создавать и управлять своими ботами. Напишите ему `/newbot` и следуйте инструкциям для создания нового бота.

⚡ Когда бот будет создан, вы получите токен, который мы используем совсем скоро.


Схема работы такая:

<img src="/static/images/aws-lambda/2019-02-24_00-29-26.png" />


### Что еще можно сделать на лямбдах?
